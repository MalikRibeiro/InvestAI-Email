name: Relat칩rio Di치rio Invest-AI

on:
  schedule:
    # Cron em UTC. 22:00 UTC = 19:00 Bras칤lia (Hor치rio Padr칚o)
    # Se quiser testar, mude para um hor치rio pr칩ximo ou use o bot칚o manual.
    - cron: '0 22 * * 1-5' 
  
  # Permite rodar manualmente na aba "Actions" do GitHub para testes
  workflow_dispatch:

jobs:
  run-invest-ai:
    runs-on: ubuntu-latest
    
    # PERMISS츾O CR칈TICA: Permite que o rob칪 salve o hist칩rico.json de volta no reposit칩rio
    permissions:
      contents: write

    steps:
      - name: Checkout do c칩digo
        uses: actions/checkout@v3

      - name: Configurar Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Instalar depend칡ncias
        run: |
          pip install -r requirements.txt

      - name: Executar Rob칪 Invest-AI
        env:
          # Mapeando os Segredos configurados no GitHub
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          LOG_LEVEL: INFO
          # A URL da Planilha j치 est치 no settings.py, n칚o precisa de segredo se for p칰blica/csv
        run: python main.py

      - name: Salvar Hist칩rico (Commit & Push)
        run: |
          # Configura o usu치rio do Git simulado
          git config --global user.name 'Invest-AI Bot'
          git config --global user.email 'bot@invest-ai.com'
          
          # Adiciona apenas os arquivos de dados que queremos preservar
          git add data/history.json
          
          # Verifica se houve mudan칞a. Se sim, faz commit e push.
          # Se n칚o houver mudan칞a (ex: feriado/bolsa fechada), n칚o faz nada e n칚o d치 erro.
          git diff --quiet && git diff --staged --quiet || (git commit -m "游뱄 Update: Hist칩rico Financeiro Di치rio" && git push)
